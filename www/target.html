<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">>
    <!-- Bootstrap core CSS -->
    <link href="pure-min.css" rel="stylesheet">
    <link href="target.css" rel="stylesheet">
  </head>
  <body>
    <div class="header">
        <div class="home-menu pure-menu pure-menu-horizontal pure-menu-fixed">
            <a class="pure-menu-heading" href="">LetMee checker</a>
        </div>
    </div>

    <div class="splash-container">
        <div class="splash">
          <div class="targets"><h1 class="splash-head">Connecting</h1></div>
        </div>
        <button class="pure-button pure-button-primary">A Primary Button</button>
    </div>
    <div class="footer l-box is-center">
        <div class="mode">You have <span id="mode_text">NULL</span> mode and you have <span id="total_points">0</span> points</div>
    </div>


    <script src="jquery_micro.js"></script>
    <script type="text/javascript">
      // target mapp
      var target_map =  { 0: 0
                        , 1: 0
                        , 2: 0
                        , 3: 0
                        , 4: 0
                        , 5: 0
                        , 6: 0
                        , 7: 0
                        , 8: 0
                        , 9: 0
                        , 10: 0
                        , 11: 0
                        , 12: 0
                        , 13: 0
                        , 14: 0
                        , 15: 0
                        , 16: 0
                        , 17: 0
                        , 18: 0
                        , 19: 0
                        , 20: 0
                        , 21: 0
                        , 22: 0
                        , 23: 0
                        , 24: 0
                        , 25: 0
                        , 26: 0
                        , 27: 0
                        , 28: 0
                        , 29: 0
                        , 30: 0
                        , 31: 0
                        , 32: 0
                        , 33: 0
                        , 34: 0
                        , 35: 0
                        , 36: 0
                        , 37: 0
                        , 38: 0
                        , 39: 0
                        , 40: 0
                        , 41: 0
                        , 42: 0
                        , 43: 0
                        , 44: 0
                        , 45: 0
                        , 46: 0
                        , 47: 0
                        , 48: 0
                        , 49: 0
                        , 50: 0
                        , 51: 0
                        , 52: 0
                        , 53: 0
                        , 54: 0
                        , 55: 0
                        , 56: 0
                        , 57: 0
                        , 58: 0
                        , 59: 0
                        , 60: 0
                        , 61: 0
                        , 62: 0
                        , 63: 0
                        , 64: 0
                        , 65: 0
                        , 66: 0
                        , 67: 0
                        , 68: 0
                        , 69: 0
                        , 70: 0
                        , 71: 0
                        , 72: 0
                        , 73: 0
                        , 74: 0
                        , 75: 0
                        , 76: 0
                        , 77: 0
                        , 78: 0
                        , 79: 0
                        , 80: 0
                        , 81: 0
                        , 82: 0
                        , 83: 0
                        , 84: 0
                        , 85: 0
                        , 86: 0
                        , 87: 0
                        , 88: 0
                        , 89: 0
                        , 90: 0 }

      // ws initialization
      var total_points = 0;
      var ws = new WebSocket("ws://192.168.4.1:80");
      ws.onopen = function () {
          // ve need to get data about target
          var data = {'i': 1};
          ws.send(JSON.stringify(data));
      };
      ws.onmessage = function (evt) {
        var data = $.parseJSON(evt.data);
        if( $.type(data) == 'string'){
          // try again
          data = $.parseJSON(data);
        }

        if (data.i == 1){
          // init sequense needs to render targets
          $( ".targets" ).empty(); // erase old data if exist
          $('#mode_text').text(data.d.m);
          renderTargets(data.d.t);
        }else if(data.i == 2){
          // somebody shoot the target send request for target id and element id
          total_points+= data.d.p;
          $('#total_points').text(total_points);
          shotPoint(data.d.t, target_map[data.d.e]);
        }
      };
      // ws.onerror = (error) => alert(error);
      ws.onclose = () => console.log('fooo cloes');

      function renderTargets(targets){
        $( ".targets" ).empty(); // erase old data if exist
        function putCircle(circle, element, tg, tot){
          var deg = 360/(circle * 6); // get degree for each element
          if (circle == 0){
            var pd = -100;
          }else{
            var pd = ((circle-1)*120);
          }
          $('#target_'+tg).append("<div class='circle' title='"+tot+"' id='p_"+tg+"_"+tot+"' style='transform: rotate("+(deg*element)+"deg) translate("+(120+pd)+"%);'></div>");
        }

        for (var tr = 0; tr < targets; tr++) {
          // and genetare each target
          $('.targets').append("<div class='circle-container' id='target_"+tr+"'></div>");
          var total = 0;
          for (var c = 0; c < 6; c++) {
            // loop for each circle vhere is i * 6 leds
            if (c == 0){
              putCircle(0, 0, tr, total++);
              continue;
            }
            for (var e = 0; e < c*6; e++) {
              // put circle ;)
              putCircle(c, e, tr, total++);
            }
          }
        }
      }

      function shotPoint(target, element){
        $('#p_'+target+'_'+element).css( "background-color", "green" );
        // $('#p_'+target+'_'+element).css( "border", "1px solid black" );
        $('#p_'+target+'_'+element).css( "z-index", "1000" );
      }
    </script>
  </body>
</html>
