<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">>
    <!-- Bootstrap core CSS -->
    <link href="pure-min.css" rel="stylesheet">
    <link href="target.css" rel="stylesheet">
  </head>
  <body>
    <div class="header">
        <div class="home-menu pure-menu pure-menu-horizontal pure-menu-fixed">
            <a class="pure-menu-heading" href="">LetMee checker</a>
        </div>
    </div>

    <div class="splash-container">
        <div class="splash">
          <div class="targets"><h1 class="splash-head">Connecting</h1></div>
        </div>
        <button class="pure-button pure-button-primary">A Primary Button</button>
    </div>
    <div class="footer l-box is-center">
        <div class="mode">You have <span id="mode_text">NULL</span> mode and you have <span id="total_points">0</span> points</div>
    </div>


    <script src="jquery_micro.js"></script>
    <script type="text/javascript">
      // ws initialization
      var total_points = 0;
      var ws = new WebSocket("ws://192.168.4.1:80");
      ws.onopen = function () {
          // ve need to get data about target
          var data = {'i': 1};
          ws.send(JSON.stringify(data));
      };
      ws.onmessage = function (evt) {
        var data = $.parseJSON(evt.data);
        console.log(data);
        if( $.type(data) == 'string'){
          // try again
          data = $.parseJSON(data);
        }

        if (data.i == 1){
          // init sequense needs to render targets
          $( ".targets" ).empty(); // erase old data if exist
          $('#mode_text').text(data.d.m);
          renderTargets(data.d.t);
        }else if(data.i == 2){
          // somebody shoot the target send request for target id and element id
          total_points+= data.d.p;
          $('#total_points').text(total_points);
          shotPoint(data.d.t, data.d.e);
        }
      };
      // ws.onerror = (error) => alert(error);
      ws.onclose = () => console.log('fooo cloes');

      function renderTargets(targets){
        $( ".targets" ).empty(); // erase old data if exist
        function putCircle(circle, element, tg, tot){
          var deg = 360/(circle * 6); // get degree for each element
          if (circle == 0){
            var pd = -100;
          }else{
            var pd = ((circle-1)*120);
          }
          $('#target_'+tg).append("<div class='circle' title='"+tot+"' id='p_"+tg+"_"+tot+"' style='transform: rotate("+(deg*element)+"deg) translate("+(120+pd)+"%);'></div>");
        }

        for (var tr = 0; tr < targets; tr++) {
          // and genetare each target
          $('.targets').append("<div class='circle-container' id='target_"+tr+"'></div>");
          var total = 0;
          for (var c = 0; c < 6; c++) {
            // loop for each circle vhere is i * 6 leds
            if (c == 0){
              putCircle(0, 0, tr, total++);
              continue;
            }
            for (var e = 0; e < c*6; e++) {
              // put circle ;)
              putCircle(c, e, tr, total++);
            }
          }
        }
      }

      function shotPoint(target, element){
        $('#p_'+target+'_'+element).css( "background-color", "green" );
        // $('#p_'+target+'_'+element).css( "border", "1px solid black" );
        $('#p_'+target+'_'+element).css( "z-index", "1000" );
      }
    </script>
  </body>
</html>
